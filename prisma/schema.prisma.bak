generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model DatabaseChangeLog {
  id          Int      @id @default(autoincrement())
  changeType  String
  description String
  details     Json?
  createdBy   String?
  createdAt   DateTime @default(now())

  @@index([changeType])
  @@index([createdAt])
}

model Order {
  id        Int         @id @default(autoincrement())
  tenantId  String
  roomId    String
  placeId   Int?
  status    String      @default("received")
  items     Json
  total     Int
  createdAt DateTime    @default(now())
  updatedAt DateTime
  paidAt    DateTime?
  isDeleted Boolean     @default(false)
  deletedAt DateTime?
  OrderItem OrderItem[]

  @@index([createdAt])
  @@index([isDeleted, paidAt])
  @@index([status])
  @@index([tenantId])
}

model OrderItem {
  id          Int       @id @default(autoincrement())
  tenantId    String
  orderId     Int
  menuItemId  Int
  name        String
  price       Int
  quantity    Int
  status      String    @default("pending")
  notes       String?
  deliveredAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime
  Order       Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([status])
  @@index([tenantId])
}

model SystemPlanRestrictions {
  id                       String             @id
  systemType               String
  businessType             String
  planType                 String
  planCategory             String
  monthlyPrice             Int
  maxDevices               Int                @default(30)
  additionalDeviceCost     Int                @default(1200)
  roomTerminalCost         Int                @default(1200)
  frontDeskCost            Int                @default(5000)
  kitchenCost              Int                @default(2000)
  barCost                  Int                @default(2000)
  housekeepingCost         Int                @default(2000)
  managerCost              Int                @default(5000)
  commonAreaCost           Int                @default(3500)
  enableAiConcierge        Boolean            @default(false)
  enableMultilingual       Boolean            @default(false)
  enableLayoutEditor       Boolean            @default(false)
  enableFacilityGuide      Boolean            @default(false)
  enableAiBusinessSupport  Boolean            @default(false)
  maxMonthlyOrders         Int                @default(1000)
  maxMonthlyAiRequests     Int                @default(0)
  maxStorageGB             Float              @default(5.0)
  multilingualUpgradePrice Int                @default(3000)
  description              String?
  createdAt                DateTime           @default(now())
  updatedAt                DateTime
  TenantSystemPlan         TenantSystemPlan[]

  @@unique([systemType, businessType, planType, planCategory], map: "SystemPlanRestrictions_systemType_businessType_planType_planCat")
}

model Tenant {
  id                       String                     @id
  name                     String
  domain                   String?                    @unique
  status                   String                     @default("active")
  contactEmail             String?
  createdAt                DateTime                   @default(now())
  features                 String[]
  planType                 String?
  settings                 Json?
  TenantSystemPlan         TenantSystemPlan[]
  device_rooms             device_rooms[]
  pages                    pages[]
  service_usage_statistics service_usage_statistics[]
  tenant_services          tenant_services[]
}

model TenantSystemPlan {
  id                     String                 @id
  tenantId               String
  systemType             String
  planId                 String
  startDate              DateTime               @default(now())
  endDate                DateTime?
  isActive               Boolean                @default(true)
  monthlyPrice           Int
  createdAt              DateTime               @default(now())
  updatedAt              DateTime
  SystemPlanRestrictions SystemPlanRestrictions @relation(fields: [planId], references: [id])
  Tenant                 Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, systemType])
  @@index([isActive])
  @@index([planId])
  @@index([systemType])
  @@index([tenantId])
}

model admin {
  id                    String      @id
  email                 String      @unique
  username              String      @unique
  display_name          String
  password_hash         String
  admin_level           AdminLevel
  accessible_group_ids  String[]
  accessible_chain_ids  String[]
  accessible_tenant_ids String[]
  last_login_at         DateTime?
  login_attempts        Int         @default(0)
  locked_until          DateTime?
  totp_secret           String?
  totp_enabled          Boolean     @default(false)
  created_at            DateTime    @default(now())
  updated_at            DateTime
  created_by            String?
  is_active             Boolean     @default(true)
  admin_log             admin_log[]
}

model admin_log {
  id            String   @id
  admin_id      String
  action        String
  target_type   String?
  target_id     String?
  ip_address    String?
  user_agent    String?
  success       Boolean  @default(true)
  error_message String?
  created_at    DateTime @default(now())
  admin         admin    @relation(fields: [admin_id], references: [id])

  @@index([action])
  @@index([admin_id])
  @@index([created_at])
}

model campaign_categories {
  id                          String                        @id
  tenantId                    String
  code                        String                        @unique
  name                        String
  description                 String?
  createdAt                   DateTime                      @default(now())
  updatedAt                   DateTime
  campaign_category_relations campaign_category_relations[]

  @@index([tenantId])
}

model campaign_category_relations {
  id                  String              @id
  campaignId          String
  categoryId          String
  createdAt           DateTime            @default(now())
  campaigns           campaigns           @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  campaign_categories campaign_categories @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([campaignId, categoryId])
}

model campaign_items {
  id         String    @id
  campaignId String
  itemId     String
  itemType   String
  priority   Int       @default(0)
  createdAt  DateTime  @default(now())
  campaigns  campaigns @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@unique([campaignId, itemId, itemType])
}

model campaign_translations {
  id           String    @id
  campaignId   String
  locale       String
  title        String
  description  String?
  imageUrl     String?
  languageCode String?
  name         String?
  campaigns    campaigns @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@unique([campaignId, locale])
  @@index([languageCode])
}

model campaign_usage_logs {
  id         String    @id
  campaignId String
  userId     String?
  deviceId   String?
  action     String
  createdAt  DateTime  @default(now())
  campaigns  campaigns @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([deviceId])
  @@index([userId])
}

model campaigns {
  id                          String                        @id
  tenantId                    String
  code                        String                        @unique
  status                      CampaignStatus                @default(DRAFT)
  displayType                 CampaignDisplayType
  startDate                   DateTime?
  endDate                     DateTime?
  priority                    Int                           @default(0)
  ctaType                     CampaignCtaType               @default(NONE)
  ctaAction                   String?
  ctaLabel                    String?
  discountType                String?
  discountValue               Decimal?                      @db.Decimal(10, 2)
  createdAt                   DateTime                      @default(now())
  updatedAt                   DateTime
  dayRestrictions             Json?
  description                 String?
  displayPriority             Int                           @default(0)
  maxUsageCount               Int?
  name                        String
  timeRestrictions            Json?
  welcomeSettings             Json?
  campaign_category_relations campaign_category_relations[]
  campaign_items              campaign_items[]
  campaign_translations       campaign_translations[]
  campaign_usage_logs         campaign_usage_logs[]

  @@index([startDate, endDate])
  @@index([status])
  @@index([tenantId])
}

model device_rooms {
  id         Int       @id @default(autoincrement())
  tenantId   String
  roomId     String
  roomName   String?
  deviceId   String?
  deviceType String?
  placeId    String?
  status     String?   @default("active")
  ipAddress  String?
  macAddress String?
  lastUsedAt DateTime?
  isActive   Boolean   @default(true)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime
  Tenant     Tenant    @relation(fields: [tenantId], references: [id])

  @@index([deviceId])
  @@index([placeId])
  @@index([roomId])
  @@index([status])
  @@index([tenantId])
}

model device_video_caches {
  id           String    @id
  deviceId     String
  videoIds     String[]
  lastShownAt  DateTime  @default(now())
  updatedAt    DateTime
  lastViewedAt DateTime?
  userId       String?
  viewed       Boolean   @default(false)

  @@unique([deviceId, userId])
}

model notification_templates {
  id         String   @id
  tenant_id  String
  type       String
  code       String
  subject    String?
  content    String
  variables  String[]
  is_active  Boolean  @default(true)
  created_at DateTime @default(now())
  updated_at DateTime
  body       String
  html       Boolean  @default(false)
  locale     String

  @@unique([tenant_id, type, code, locale])
  @@index([tenant_id])
  @@index([type])
}

model page_histories {
  Id        String   @id
  PageId    String
  Html      String?
  Css       String?
  Content   String?
  Template  String?
  Version   Int
  CreatedAt DateTime @default(now())
  CreatedBy String?
  pages     pages    @relation(fields: [PageId], references: [Id], onDelete: Cascade)

  @@index([PageId])
  @@index([Version])
}

model pages {
  Id             String           @id
  TenantId       String
  Slug           String
  Title          String
  Html           String?
  Css            String?
  Content        String?
  Template       String?
  IsPublished    Boolean          @default(false)
  PublishedAt    DateTime?
  Version        Int              @default(1)
  CreatedAt      DateTime         @default(now())
  UpdatedAt      DateTime
  page_histories page_histories[]
  Tenant         Tenant           @relation(fields: [TenantId], references: [id])

  @@unique([TenantId, Slug])
  @@index([IsPublished])
  @@index([Slug])
  @@index([TenantId])
}

model response_node_translations {
  id             String         @id
  nodeId         String
  locale         String
  content        String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime
  answer         Json?
  language       String?
  title          String?
  response_nodes response_nodes @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  @@unique([nodeId, language])
  @@unique([nodeId, locale])
}

model response_nodes {
  id                         String                       @id
  treeId                     String
  nodeType                   String
  content                    String?
  metadata                   Json?
  isRoot                     Boolean                      @default(false)
  parentId                   String?
  position                   Int                          @default(0)
  createdAt                  DateTime                     @default(now())
  updatedAt                  DateTime
  answer                     Json?
  description                String?
  icon                       String?
  order                      Int                          @default(0)
  title                      String?
  type                       String?
  response_node_translations response_node_translations[]
  response_nodes             response_nodes?              @relation("response_nodesToresponse_nodes", fields: [parentId], references: [id])
  other_response_nodes       response_nodes[]             @relation("response_nodesToresponse_nodes")
  response_trees             response_trees               @relation(fields: [treeId], references: [id], onDelete: Cascade)
  response_tree_history      response_tree_history[]
  response_tree_sessions     response_tree_sessions[]

  @@index([isRoot])
  @@index([parentId])
  @@index([treeId])
}

model response_tree_history {
  id                     String                 @id
  sessionId              String
  nodeId                 String
  response               String?
  metadata               Json?
  createdAt              DateTime               @default(now())
  action                 String?
  timestamp              DateTime               @default(now())
  response_nodes         response_nodes         @relation(fields: [nodeId], references: [id])
  response_tree_sessions response_tree_sessions @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
}

model response_tree_mobile_links {
  id                     String                 @id
  sessionId              String
  code                   String                 @unique
  qrCodeData             String?
  isActive               Boolean                @default(true)
  connectionId           String?
  createdAt              DateTime               @default(now())
  expiresAt              DateTime
  connectedAt            DateTime?
  deviceId               Int?
  response_tree_sessions response_tree_sessions @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([code])
  @@index([isActive])
}

model response_tree_sessions {
  id                         String                       @id
  treeId                     String
  userId                     String?
  deviceId                   String?
  currentNodeId              String?
  metadata                   Json?
  isComplete                 Boolean                      @default(false)
  startedAt                  DateTime                     @default(now())
  updatedAt                  DateTime
  completedAt                DateTime?
  endedAt                    DateTime?
  interfaceType              String?
  language                   String?
  lastActivityAt             DateTime?
  roomId                     String?
  sessionId                  String                       @unique
  response_tree_history      response_tree_history[]
  response_tree_mobile_links response_tree_mobile_links[]
  response_nodes             response_nodes?              @relation(fields: [currentNodeId], references: [id])
  response_trees             response_trees               @relation(fields: [treeId], references: [id], onDelete: Cascade)

  @@index([deviceId])
  @@index([isComplete])
  @@index([treeId])
  @@index([userId])
}

model response_tree_versions {
  id             String         @id
  treeId         String
  version        Int
  snapshot       Json
  createdAt      DateTime       @default(now())
  createdBy      String?
  data           Json?
  response_trees response_trees @relation(fields: [treeId], references: [id], onDelete: Cascade)

  @@unique([treeId, version])
}

model response_trees {
  id                     String                   @id
  tenantId               String
  name                   String
  description            String?
  isPublished            Boolean                  @default(false)
  publishedAt            DateTime?
  version                Int                      @default(1)
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime
  isActive               Boolean                  @default(true)
  response_nodes         response_nodes[]
  response_tree_sessions response_tree_sessions[]
  response_tree_versions response_tree_versions[]

  @@index([isPublished])
  @@index([tenantId])
}

model room_grades {
  id          String   @id
  tenant_id   String
  code        String
  name        String
  description String?
  created_at  DateTime @default(now())
  updated_at  DateTime

  @@unique([tenant_id, code])
  @@index([tenant_id])
}

model schema_version {
  version      String   @id
  description  String
  rollback_sql String?
  applied_at   DateTime @default(now())
  applied_by   String?
}

model service_plan_restrictions {
  id                        String   @id
  service_type              String
  plan_type                 String
  plan_category             String
  max_users                 Int      @default(10)
  max_devices               Int      @default(5)
  max_monthly_orders        Int?
  enable_ai_concierge       Boolean?
  enable_multilingual       Boolean?
  max_rooms                 Int?
  enable_revenue_management Boolean?
  max_monthly_ai_requests   Int?
  enable_ai_crm             Boolean?
  monthly_price             Int      @default(9800)
  created_at                DateTime @default(now())
  updated_at                DateTime @default(now())

  @@unique([service_type, plan_type, plan_category], map: "service_plan_restrictions_service_type_plan_type_plan_category_")
}

model service_usage_statistics {
  id                   String   @id
  tenant_id            String
  service_type         String
  month                String
  active_users_count   Int      @default(0)
  active_devices_count Int      @default(0)
  usage_data           Json     @default("{}")
  created_at           DateTime @default(now())
  updated_at           DateTime @default(now())
  Tenant               Tenant   @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  @@unique([tenant_id, service_type, month])
}

model staff {
  id                 String    @id
  tenant_id          String
  email              String
  name               String
  role               String
  department         String?
  is_active          Boolean   @default(true)
  created_at         DateTime  @default(now())
  updated_at         DateTime
  failed_login_count Int       @default(0)
  last_login_at      DateTime?
  locked_until       DateTime?
  password_hash      String?

  @@unique([tenant_id, email])
  @@index([email])
  @@index([role])
  @@index([tenant_id])
}

model system_event {
  id            String    @id
  tenant_id     String
  user_id       String?
  event_type    String
  source_system String
  target_system String
  entity_type   String
  entity_id     String
  action        String
  event_data    Json?
  created_at    DateTime  @default(now())
  processed_at  DateTime?
  status        String    @default("PENDING")

  @@index([created_at])
  @@index([event_type])
  @@index([status])
  @@index([tenant_id])
}

model tenant_access_logs {
  id            String   @id
  tenant_id     String
  user_id       String?
  action        String
  resource      String?
  ip_address    String?
  user_agent    String?
  created_at    DateTime @default(now())
  source_system String?

  @@index([created_at])
  @@index([tenant_id])
  @@index([user_id])
}

model tenant_services {
  id             String    @id
  tenant_id      String
  service_type   String
  plan_type      String
  is_active      Boolean   @default(true)
  activated_at   DateTime  @default(now())
  expires_at     DateTime?
  service_config Json      @default("{}")
  created_at     DateTime  @default(now())
  updated_at     DateTime  @default(now())
  Tenant         Tenant    @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  @@unique([tenant_id, service_type])
}

enum AdminLevel {
  chainadmin
  groupadmin
  superadmin
}

enum CampaignCtaType {
  NONE
  LINK
  BUTTON
  COUPON
}

enum CampaignDisplayType {
  BANNER
  POPUP
  NOTIFICATION
  FEATURED
}

enum CampaignStatus {
  DRAFT
  ACTIVE
  PAUSED
  ENDED
  SCHEDULED
}
