generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model DatabaseChangeLog {
  id          Int      @id @default(autoincrement())
  changeType  String
  description String
  details     Json?
  createdBy   String?
  createdAt   DateTime @default(now())

  @@index([changeType])
  @@index([createdAt])
}

model Order {
  id        Int         @id @default(autoincrement())
  tenantId  String
  roomId    String
  placeId   Int?
  status    String      @default("received")
  items     Json
  total     Int
  createdAt DateTime    @default(now())
  updatedAt DateTime
  paidAt    DateTime?
  isDeleted Boolean     @default(false)
  deletedAt DateTime?
  uuid      String?     @unique
  sessionId String?
  OrderItem OrderItem[]

  @@index([createdAt])
  @@index([isDeleted, paidAt])
  @@index([status])
  @@index([tenantId])
  @@index([sessionId])
}

model OrderItem {
  id          Int       @id @default(autoincrement())
  tenantId    String
  orderId     Int
  menuItemId  Int
  name        String
  price       Int
  quantity    Int
  status      String    @default("pending")
  notes       String?
  deliveredAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime
  deleted_at  DateTime?
  deleted_by  String?
  is_deleted  Boolean   @default(false)
  Order       Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([is_deleted])
  @@index([orderId])
  @@index([status])
  @@index([tenantId])
}

model SystemPlanRestrictions {
  id                       String             @id
  systemType               String
  businessType             String
  planType                 String
  planCategory             String
  monthlyPrice             Int
  maxDevices               Int                @default(30)
  additionalDeviceCost     Int                @default(1200)
  roomTerminalCost         Int                @default(1200)
  frontDeskCost            Int                @default(5000)
  kitchenCost              Int                @default(2000)
  barCost                  Int                @default(2000)
  housekeepingCost         Int                @default(2000)
  managerCost              Int                @default(5000)
  commonAreaCost           Int                @default(3500)
  enableAiConcierge        Boolean            @default(false)
  enableMultilingual       Boolean            @default(false)
  enableLayoutEditor       Boolean            @default(false)
  enableFacilityGuide      Boolean            @default(false)
  enableAiBusinessSupport  Boolean            @default(false)
  maxMonthlyOrders         Int                @default(1000)
  maxMonthlyAiRequests     Int                @default(0)
  maxStorageGB             Float              @default(5.0)
  multilingualUpgradePrice Int                @default(3000)
  description              String?
  createdAt                DateTime           @default(now())
  updatedAt                DateTime
  deleted_at               DateTime?
  deleted_by               String?
  is_deleted               Boolean            @default(false)
  TenantSystemPlan         TenantSystemPlan[]

  @@unique([systemType, businessType, planType, planCategory], map: "SystemPlanRestrictions_systemType_businessType_planType_planCat")
  @@index([is_deleted])
}

model Tenant {
  id                       String                     @id
  name                     String
  domain                   String?                    @unique
  contactEmail             String?
  createdAt                DateTime                   @default(now())
  deleted_at               DateTime?
  deleted_by               String?
  features                 String[]
  is_deleted               Boolean                    @default(false)
  planType                 String?
  settings                 Json?
  status                   String                     @default("active")
  TenantSystemPlan         TenantSystemPlan[]
  device_rooms             device_rooms[]
  pages                    pages[]
  service_usage_statistics service_usage_statistics[]
  tenant_services          tenant_services[]

  @@index([is_deleted])
}

model TenantSystemPlan {
  id                     String                 @id
  tenantId               String
  systemType             String
  planId                 String
  startDate              DateTime               @default(now())
  endDate                DateTime?
  isActive               Boolean                @default(true)
  monthlyPrice           Int
  createdAt              DateTime               @default(now())
  updatedAt              DateTime
  deleted_at             DateTime?
  deleted_by             String?
  is_deleted             Boolean                @default(false)
  SystemPlanRestrictions SystemPlanRestrictions @relation(fields: [planId], references: [id])
  Tenant                 Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, systemType])
  @@index([isActive])
  @@index([is_deleted])
  @@index([planId])
  @@index([systemType])
  @@index([tenantId])
}

model admin {
  id                    String      @id
  email                 String      @unique
  username              String      @unique
  display_name          String
  password_hash         String
  admin_level           AdminLevel
  accessible_group_ids  String[]
  accessible_chain_ids  String[]
  accessible_tenant_ids String[]
  last_login_at         DateTime?
  login_attempts        Int         @default(0)
  locked_until          DateTime?
  totp_secret           String?
  totp_enabled          Boolean     @default(false)
  created_at            DateTime    @default(now())
  updated_at            DateTime
  created_by            String?
  is_active             Boolean     @default(true)
  deleted_at            DateTime?
  deleted_by            String?
  is_deleted            Boolean     @default(false)
  admin_log             admin_log[]

  @@index([is_deleted])
}

model admin_log {
  id            String    @id
  admin_id      String
  action        String
  target_type   String?
  target_id     String?
  ip_address    String?
  user_agent    String?
  success       Boolean   @default(true)
  error_message String?
  created_at    DateTime  @default(now())
  deleted_at    DateTime?
  deleted_by    String?
  is_deleted    Boolean   @default(false)
  admin         admin     @relation(fields: [admin_id], references: [id])

  @@index([action])
  @@index([admin_id])
  @@index([created_at])
  @@index([is_deleted])
}

model campaign_categories {
  id                          String                        @id
  tenantId                    String
  code                        String                        @unique
  name                        String
  description                 String?
  createdAt                   DateTime                      @default(now())
  updatedAt                   DateTime
  deleted_at                  DateTime?
  deleted_by                  String?
  is_deleted                  Boolean                       @default(false)
  campaign_category_relations campaign_category_relations[]

  @@index([is_deleted])
  @@index([tenantId])
}

model campaign_category_relations {
  id                  String              @id
  campaignId          String
  categoryId          String
  createdAt           DateTime            @default(now())
  deleted_at          DateTime?
  deleted_by          String?
  is_deleted          Boolean             @default(false)
  campaigns           campaigns           @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  campaign_categories campaign_categories @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([campaignId, categoryId])
  @@index([is_deleted])
}

model campaign_items {
  id         String    @id
  campaignId String
  itemId     String
  itemType   String
  priority   Int       @default(0)
  createdAt  DateTime  @default(now())
  deleted_at DateTime?
  deleted_by String?
  is_deleted Boolean   @default(false)
  campaigns  campaigns @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@unique([campaignId, itemId, itemType])
  @@index([is_deleted])
}

model campaign_translations {
  id           String    @id
  campaignId   String
  locale       String
  title        String
  description  String?
  imageUrl     String?
  languageCode String?
  name         String?
  deleted_at   DateTime?
  deleted_by   String?
  is_deleted   Boolean   @default(false)
  campaigns    campaigns @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@unique([campaignId, locale])
  @@index([is_deleted])
  @@index([languageCode])
}

model campaign_usage_logs {
  id         String    @id
  campaignId String
  userId     String?
  deviceId   String?
  action     String
  createdAt  DateTime  @default(now())
  deleted_at DateTime?
  deleted_by String?
  is_deleted Boolean   @default(false)
  campaigns  campaigns @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([deviceId])
  @@index([is_deleted])
  @@index([userId])
}

model campaigns {
  id                          String                        @id
  tenantId                    String
  code                        String                        @unique
  status                      CampaignStatus                @default(DRAFT)
  displayType                 CampaignDisplayType
  startDate                   DateTime?
  endDate                     DateTime?
  priority                    Int                           @default(0)
  ctaType                     CampaignCtaType               @default(NONE)
  ctaAction                   String?
  ctaLabel                    String?
  discountType                String?
  discountValue               Decimal?                      @db.Decimal(10, 2)
  createdAt                   DateTime                      @default(now())
  updatedAt                   DateTime
  dayRestrictions             Json?
  description                 String?
  displayPriority             Int                           @default(0)
  maxUsageCount               Int?
  name                        String
  timeRestrictions            Json?
  welcomeSettings             Json?
  deleted_at                  DateTime?
  deleted_by                  String?
  is_deleted                  Boolean                       @default(false)
  campaign_category_relations campaign_category_relations[]
  campaign_items              campaign_items[]
  campaign_translations       campaign_translations[]
  campaign_usage_logs         campaign_usage_logs[]

  @@index([is_deleted])
  @@index([startDate, endDate])
  @@index([status])
  @@index([tenantId])
}

model customers {
  id                   String         @id
  tenant_id            String
  name                 String
  email                String?
  phone                String?
  address              String?
  birth_date           DateTime?
  member_id            String?
  rank_id              String?
  total_points         Int            @default(0)
  total_stays          Int            @default(0)
  pms_updatable_fields String[]       @default(["name", "phone", "address"])
  origin_system        String         @default("hotel-member")
  synced_at            DateTime       @default(now())
  updated_by_system    String         @default("hotel-member")
  preferences          Json           @default("{}")
  created_at           DateTime       @default(now())
  updated_at           DateTime
  deleted_at           DateTime?
  is_deleted           Boolean        @default(false)
  deleted_by           String?
  reservations         reservations[]

  @@index([email])
  @@index([is_deleted])
  @@index([member_id])
  @@index([tenant_id])
}

model device_rooms {
  id         Int       @id @default(autoincrement())
  tenantId   String
  roomId     String
  roomName   String?
  deviceId   String?
  deviceType String?
  placeId    String?
  status     String?   @default("active")
  ipAddress  String?
  macAddress String?
  lastUsedAt DateTime?
  isActive   Boolean   @default(true)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime
  is_deleted Boolean   @default(false)
  deleted_at DateTime?
  deleted_by String?
  Tenant     Tenant    @relation(fields: [tenantId], references: [id])

  @@index([deviceId])
  @@index([is_deleted])
  @@index([placeId])
  @@index([roomId])
  @@index([status])
  @@index([tenantId])
}

model device_video_caches {
  id           String    @id
  deviceId     String
  videoIds     String[]
  lastShownAt  DateTime  @default(now())
  updatedAt    DateTime
  lastViewedAt DateTime?
  userId       String?
  viewed       Boolean   @default(false)
  deleted_at   DateTime?
  deleted_by   String?
  is_deleted   Boolean   @default(false)

  @@unique([deviceId, userId])
  @@index([is_deleted])
}

model notification_templates {
  id         String    @id
  tenant_id  String
  type       String
  code       String
  subject    String?
  content    String
  variables  String[]
  is_active  Boolean   @default(true)
  created_at DateTime  @default(now())
  updated_at DateTime
  body       String
  html       Boolean   @default(false)
  locale     String
  deleted_at DateTime?
  deleted_by String?
  is_deleted Boolean   @default(false)

  @@unique([tenant_id, type, code, locale])
  @@index([is_deleted])
  @@index([tenant_id])
  @@index([type])
}

model page_histories {
  Id         String    @id
  PageId     String
  Html       String?
  Css        String?
  Content    String?
  Template   String?
  Version    Int
  CreatedAt  DateTime  @default(now())
  CreatedBy  String?
  deleted_at DateTime?
  deleted_by String?
  is_deleted Boolean   @default(false)
  pages      pages     @relation(fields: [PageId], references: [Id], onDelete: Cascade)

  @@index([PageId])
  @@index([Version])
  @@index([is_deleted])
}

model pages {
  Id             String           @id
  TenantId       String
  Slug           String
  Title          String
  Html           String?
  Css            String?
  Content        String?
  Template       String?
  IsPublished    Boolean          @default(false)
  PublishedAt    DateTime?
  Version        Int              @default(1)
  CreatedAt      DateTime         @default(now())
  UpdatedAt      DateTime
  deleted_at     DateTime?
  deleted_by     String?
  is_deleted     Boolean          @default(false)
  page_histories page_histories[]
  Tenant         Tenant           @relation(fields: [TenantId], references: [id])

  @@unique([TenantId, Slug])
  @@index([IsPublished])
  @@index([Slug])
  @@index([TenantId])
  @@index([is_deleted])
}

model reservations {
  id                  String     @id
  tenant_id           String
  customer_id         String?
  guest_name          String
  guest_phone         String?
  guest_email         String?
  checkin_date        DateTime
  checkout_date       DateTime
  adult_count         Int        @default(1)
  child_count         Int        @default(0)
  room_type           String
  room_number         String?
  total_amount        Decimal    @db.Decimal(10, 2)
  deposit_amount      Decimal    @default(0) @db.Decimal(10, 2)
  status              String     @default("PENDING")
  origin              String
  ota_id              String?
  confirmation_number String
  special_requests    String?
  internal_notes      String?
  origin_system       String     @default("hotel-pms")
  synced_at           DateTime   @default(now())
  updated_by_system   String     @default("hotel-pms")
  created_at          DateTime   @default(now())
  updated_at          DateTime
  deleted_at          DateTime?
  is_deleted          Boolean    @default(false)
  deleted_by          String?
  customers           customers? @relation(fields: [customer_id], references: [id])

  @@index([checkin_date])
  @@index([checkout_date])
  @@index([is_deleted])
  @@index([status])
  @@index([tenant_id])
}

model response_node_translations {
  id             String         @id
  nodeId         String
  locale         String
  content        String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime
  answer         Json?
  language       String?
  title          String?
  deleted_at     DateTime?
  deleted_by     String?
  is_deleted     Boolean        @default(false)
  response_nodes response_nodes @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  @@unique([nodeId, language])
  @@unique([nodeId, locale])
  @@index([is_deleted])
}

model response_nodes {
  id                         String                       @id
  treeId                     String
  nodeType                   String
  content                    String?
  metadata                   Json?
  isRoot                     Boolean                      @default(false)
  parentId                   String?
  position                   Int                          @default(0)
  createdAt                  DateTime                     @default(now())
  updatedAt                  DateTime
  answer                     Json?
  description                String?
  icon                       String?
  order                      Int                          @default(0)
  title                      String?
  type                       String?
  response_node_translations response_node_translations[]
  response_nodes             response_nodes?              @relation("response_nodesToresponse_nodes", fields: [parentId], references: [id])
  other_response_nodes       response_nodes[]             @relation("response_nodesToresponse_nodes")
  response_trees             response_trees               @relation(fields: [treeId], references: [id], onDelete: Cascade)
  response_tree_history      response_tree_history[]
  response_tree_sessions     response_tree_sessions[]

  @@index([isRoot])
  @@index([parentId])
  @@index([treeId])
}

model response_tree_history {
  id                     String                 @id
  sessionId              String
  nodeId                 String
  response               String?
  metadata               Json?
  createdAt              DateTime               @default(now())
  action                 String?
  timestamp              DateTime               @default(now())
  response_nodes         response_nodes         @relation(fields: [nodeId], references: [id])
  response_tree_sessions response_tree_sessions @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
}

model response_tree_mobile_links {
  id                     String                 @id
  sessionId              String
  code                   String                 @unique
  qrCodeData             String?
  isActive               Boolean                @default(true)
  connectionId           String?
  createdAt              DateTime               @default(now())
  expiresAt              DateTime
  connectedAt            DateTime?
  deviceId               Int?
  response_tree_sessions response_tree_sessions @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([code])
  @@index([isActive])
}

model response_tree_sessions {
  id                         String                       @id
  treeId                     String
  userId                     String?
  deviceId                   String?
  currentNodeId              String?
  metadata                   Json?
  isComplete                 Boolean                      @default(false)
  startedAt                  DateTime                     @default(now())
  updatedAt                  DateTime
  completedAt                DateTime?
  endedAt                    DateTime?
  interfaceType              String?
  language                   String?
  lastActivityAt             DateTime?
  roomId                     String?
  sessionId                  String                       @unique
  response_tree_history      response_tree_history[]
  response_tree_mobile_links response_tree_mobile_links[]
  response_nodes             response_nodes?              @relation(fields: [currentNodeId], references: [id])
  response_trees             response_trees               @relation(fields: [treeId], references: [id], onDelete: Cascade)

  @@index([deviceId])
  @@index([isComplete])
  @@index([treeId])
  @@index([userId])
}

model response_tree_versions {
  id             String         @id
  treeId         String
  version        Int
  snapshot       Json
  createdAt      DateTime       @default(now())
  createdBy      String?
  data           Json?
  response_trees response_trees @relation(fields: [treeId], references: [id], onDelete: Cascade)

  @@unique([treeId, version])
}

model response_trees {
  id                     String                   @id
  tenantId               String
  name                   String
  description            String?
  isPublished            Boolean                  @default(false)
  publishedAt            DateTime?
  version                Int                      @default(1)
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime
  isActive               Boolean                  @default(true)
  deleted_at             DateTime?
  deleted_by             String?
  is_deleted             Boolean                  @default(false)
  response_nodes         response_nodes[]
  response_tree_sessions response_tree_sessions[]
  response_tree_versions response_tree_versions[]

  @@index([isPublished])
  @@index([is_deleted])
  @@index([tenantId])
}

model room_grades {
  id          String   @id
  tenant_id   String
  code        String
  name        String
  description String?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@unique([tenant_id, code])
  @@index([tenant_id])
}

model schema_version {
  version      String   @id
  description  String
  rollback_sql String?
  applied_at   DateTime @default(now())
  applied_by   String?
}

model service_plan_restrictions {
  id                        String   @id
  service_type              String
  plan_type                 String
  plan_category             String
  max_users                 Int      @default(10)
  max_devices               Int      @default(5)
  max_monthly_orders        Int?
  enable_ai_concierge       Boolean?
  enable_multilingual       Boolean?
  max_rooms                 Int?
  enable_revenue_management Boolean?
  max_monthly_ai_requests   Int?
  enable_ai_crm             Boolean?
  monthly_price             Int      @default(9800)
  created_at                DateTime @default(now())
  updated_at                DateTime @default(now())

  @@unique([service_type, plan_type, plan_category], map: "service_plan_restrictions_service_type_plan_type_plan_category_")
}

model service_usage_statistics {
  id                   String   @id
  tenant_id            String
  service_type         String
  month                String
  active_users_count   Int      @default(0)
  active_devices_count Int      @default(0)
  usage_data           Json     @default("{}")
  created_at           DateTime @default(now())
  updated_at           DateTime @default(now())
  Tenant               Tenant   @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  @@unique([tenant_id, service_type, month])
}

model staff {
  id                 String    @id
  tenant_id          String
  email              String
  name               String
  role               String
  department         String?
  is_active          Boolean   @default(true)
  created_at         DateTime  @default(now())
  updated_at         DateTime
  failed_login_count Int       @default(0)
  last_login_at      DateTime?
  locked_until       DateTime?
  password_hash      String?
  deleted_at         DateTime?
  deleted_by         String?
  is_deleted         Boolean   @default(false)

  @@unique([tenant_id, email])
  @@index([email])
  @@index([is_deleted])
  @@index([role])
  @@index([tenant_id])
}

model system_event {
  id            String    @id
  tenant_id     String
  user_id       String?
  event_type    String
  source_system String
  target_system String
  entity_type   String
  entity_id     String
  action        String
  event_data    Json?
  created_at    DateTime  @default(now())
  processed_at  DateTime?
  status        String    @default("PENDING")

  @@index([created_at])
  @@index([event_type])
  @@index([status])
  @@index([tenant_id])
}

model tenant_access_logs {
  id            String   @id
  tenant_id     String
  user_id       String?
  action        String
  resource      String?
  ip_address    String?
  user_agent    String?
  created_at    DateTime @default(now())
  source_system String?

  @@index([created_at])
  @@index([tenant_id])
  @@index([user_id])
}

model tenant_services {
  id             String    @id
  tenant_id      String
  service_type   String
  plan_type      String
  is_active      Boolean   @default(true)
  activated_at   DateTime  @default(now())
  expires_at     DateTime?
  service_config Json      @default("{}")
  created_at     DateTime  @default(now())
  updated_at     DateTime  @default(now())
  Tenant         Tenant    @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  @@unique([tenant_id, service_type])
}

enum AdminLevel {
  chainadmin
  groupadmin
  superadmin
}

enum CampaignCtaType {
  NONE
  LINK
  BUTTON
  COUPON
}

enum CampaignDisplayType {
  BANNER
  POPUP
  NOTIFICATION
  FEATURED
}

enum CampaignStatus {
  DRAFT
  ACTIVE
  PAUSED
  ENDED
  SCHEDULED
}

// Session Management Models
model checkin_sessions {
  id                String    @id @default(cuid())
  tenant_id         String
  session_number    String    @unique
  reservation_id    String?
  room_id           String
  guest_info        Json
  adults            Int       @default(1)
  children          Int       @default(0)
  check_in_at       DateTime
  check_out_at      DateTime?
  planned_check_out DateTime
  status            String    @default("ACTIVE")
  special_requests  String?
  notes             String?
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt

  @@index([tenant_id])
  @@index([session_number])
  @@index([room_id])
  @@index([status])
  @@index([check_in_at])
}

model session_billings {
  id              String    @id @default(cuid())
  tenant_id       String
  session_id      String
  billing_number  String    @unique
  room_charges    Json
  service_charges Json
  taxes           Json
  discounts       Json
  subtotal_amount Int
  tax_amount      Int
  total_amount    Int
  paid_amount     Int       @default(0)
  status          String    @default("PENDING")
  payment_method  String?
  payment_date    DateTime?
  due_date        DateTime
  notes           String?
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  @@index([tenant_id])
  @@index([session_id])
  @@index([billing_number])
  @@index([status])
  @@index([due_date])
}

// Room Management Models
model Room {
  id          String    @id @default(cuid())
  tenantId    String
  roomNumber  String
  roomType    String
  floor       Int?
  status      String    @default("AVAILABLE")
  capacity    Int       @default(2)
  amenities   Json?
  lastCleaned DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  isDeleted   Boolean   @default(false)
  deletedAt   DateTime?
  deletedBy   String?

  @@unique([tenantId, roomNumber])
  @@index([tenantId])
  @@index([status])
  @@index([roomType])
  @@index([floor])
  @@index([isDeleted])
  @@map("rooms")
}

// Room Memo Models (Phase 1: REST, Phase 2: WS)
model RoomMemo {
  id                 String    @id @default(cuid())
  tenantId           String    @map("tenant_id")
  roomId             String    @map("room_id")
  category           String
  visibility         String    @default("public")
  visibleRoles       String[]  @map("visible_roles")
  content            String
  status             String    @default("pending")
  priority           String    @default("normal")
  dueDate            DateTime? @map("due_date")
  createdByStaffId   String    @map("created_by_staff_id")
  assignedToStaffId  String?   @map("assigned_to_staff_id")
  updatedByStaffId   String?   @map("updated_by_staff_id")
  isDeleted          Boolean   @default(false) @map("is_deleted")
  deletedAt          DateTime? @map("deleted_at")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  @@index([tenantId, roomId, status], map: "idx_room_memos_tenant_room_status")
  @@index([assignedToStaffId, status], map: "idx_room_memos_assignee_status")
  @@index([createdAt], map: "idx_room_memos_created_at")
  @@map("room_memos")
}

model RoomMemoComment {
  id               String    @id @default(cuid())
  tenantId         String    @map("tenant_id")
  memoId           String    @map("memo_id")
  parentCommentId  String?   @map("parent_comment_id")
  content          String
  commentType      String    @default("comment") @map("comment_type")
  statusFrom       String?   @map("status_from")
  statusTo         String?   @map("status_to")
  createdByStaffId String    @map("created_by_staff_id")
  createdAt        DateTime  @default(now()) @map("created_at")

  @@index([tenantId, memoId, createdAt], map: "idx_memo_comments_memo_created")
  @@map("room_memo_comments")
}

model RoomMemoStatusLog {
  id               String    @id @default(cuid())
  tenantId         String    @map("tenant_id")
  memoId           String    @map("memo_id")
  statusFrom       String    @map("status_from")
  statusTo         String    @map("status_to")
  comment          String?
  changedByStaffId String    @map("changed_by_staff_id")
  createdAt        DateTime  @default(now()) @map("created_at")

  @@index([tenantId, memoId, createdAt], map: "idx_memo_status_memo_created")
  @@map("room_memo_status_logs")
}

// Phase 2 で使用
model RoomMemoRead {
  id       String   @id @default(cuid())
  tenantId String   @map("tenant_id")
  memoId   String   @map("memo_id")
  staffId  String   @map("staff_id")
  readAt   DateTime @default(now()) @map("read_at")

  @@unique([tenantId, memoId, staffId], map: "uq_memo_read_once")
  @@map("room_memo_reads")
}

// Transaction Management Models
model Transaction {
  id          String    @id @default(cuid())
  tenantId    String
  invoiceId   String?
  paymentId   String?
  type        String
  amount      Int
  taxAmount   Int       @default(0)
  totalAmount Int
  status      String    @default("PENDING")
  description String?
  reference   String?
  metadata    Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdBy   String?
  isDeleted   Boolean   @default(false)
  deletedAt   DateTime?
  deletedBy   String?

  // Relations
  invoice Invoice? @relation(fields: [invoiceId], references: [id])
  // 1-1 relation via Payment.transactionId -> Transaction.id
  payment Payment? @relation("TransactionPayment")

  @@index([tenantId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@index([isDeleted])
  @@map("transactions")
}

// Payment Management Models
// Invoice model is defined just above Payment
model Invoice {
  id             String    @id @default(cuid())
  tenantId       String
  invoiceNumber  String    @unique
  customerId     String?
  customerName   String
  customerEmail  String?
  billingAddress Json?
  items          Json
  subtotal       Int
  taxAmount      Int
  totalAmount    Int
  status         String    @default("DRAFT") // DRAFT, SENT, PAID, OVERDUE, CANCELLED
  dueDate        DateTime?
  issuedAt       DateTime?
  paidAt         DateTime?
  notes          String?
  metadata       Json?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  createdBy      String?
  isDeleted      Boolean   @default(false)
  deletedAt      DateTime?
  deletedBy      String?

  // Back-relations
  transactions Transaction[]
  payments     Payment[]

  @@index([tenantId])
  @@index([status])
  @@index([createdAt])
  @@index([isDeleted])
  @@index([invoiceNumber])
  @@map("invoices")
}

model Payment {
  id            String    @id @default(cuid())
  tenantId      String
  transactionId String?   @unique
  invoiceId     String?
  paymentMethod String
  amount        Int
  status        String    @default("PENDING")
  reference     String?
  metadata      Json?
  processedAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdBy     String?
  isDeleted     Boolean   @default(false)
  deletedAt     DateTime?
  deletedBy     String?

  // Relations
  invoice     Invoice?     @relation(fields: [invoiceId], references: [id])
  // 1-1 relation: Payment holds FK to Transaction
  transaction Transaction? @relation("TransactionPayment", fields: [transactionId], references: [id])

  @@index([tenantId])
  @@index([paymentMethod])
  @@index([status])
  @@index([createdAt])
  @@index([isDeleted])
  @@map("payments")
}
