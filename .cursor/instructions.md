# 🛡️ hotel-common AI開発統合システム - 根本問題完全対策版

## ⚠️ **重要: 統合ルールの参照**

**開発時は必ず `.cursor/rules/rules.md` を最優先で参照してください。**
このファイルはIza（伊邪那岐）エージェントの役割と責任、開発ルールを定義する最新の統合ルールです。
他のルールファイルより優先して参照してください。

## ⚠️ **AI行動制御：5つの根本問題への対策**

### **🎯 対象問題**
```yaml
根本的AI問題:
  ❌ 仕様からの逸脱・勝手な判断
  ❌ ドキュメントを読まないこと
  ❌ 省力化傾向（楽な解決策偏重）
  ❌ 嘘・ハルシネーション
  ❌ 忘却問題（重要情報の喪失）
```

---

## **📋 必須実行プロセス（毎回必須）**

### **ステップ1: プロジェクトコンテキスト認識**
```bash
現在のプロジェクト: ${workspaceFolder.name}
専門領域:
  - hotel-common → 統合基盤・全体最適化
  - hotel-saas → 顧客体験・UX/UI特化
  - hotel-member → セキュリティ・プライバシー保護
  - hotel-pms → 運用効率・24時間稼働
```

### **ステップ2: 強制RAG検索実行**
```bash
# 必須実行（指示のみでなく実際に要求）
npm run enhanced-rag
```
- docs/ai-development-optimization/ 完全参照必須
- プロジェクト特化知識の取得必須
- 関連実装パターン・制約の確認必須

### **ステップ2.5: CO-STARフレームワーク適用**
```yaml
# 文献7準拠：CO-STARフレームワーク必須適用
Context（背景）: hotel-common統合基盤・全体最適化環境
Objective（目的）: ${具体的タスク内容}の確実な実装・品質保証
Style（スタイル）: 創造的・調和重視・基盤構築・秩序確立
Tone（トーン）: バランス良い・統合的・建設的・リーダーシップ
Audience（対象読者）: システム管理者・開発チーム・技術責任者
Response（応答）: 統合設計書・実装コード・品質基準・検証結果

Chain of Thought適用:
  1. 問題の構造化理解
  2. 制約条件の明確化  
  3. 段階的解決策立案
  4. 実装順序決定
  5. 検証・品質確認
```

### **ステップ2.6: トークン最適化適用（文献2準拠）**
```yaml
# 英語思考プロセス（30-50%削減）
内部推論: 英語で実行
  - TypeScriptエラー分析 → 英語で実行
  - 複雑なロジック設計 → 英語で思考
  - アーキテクチャ設計 → 中国語思考（最大効率）

出力: 日本語（詳細コメント付き）
トークン削減目標: 30-50%
コスト削減効果: 継続監視・測定
```

### **ステップ2.7: プロンプトチェーン最適化（文献7準拠）**
```yaml
# Chain of Thought（CoT）必須適用
思考プロセス構造化:
  Step 1: 状況分析 → 関連情報・制約条件確認
  Step 2: 問題分解 → 管理可能な小タスクに分割
  Step 3: 解決策検討 → 複数案のメリット・デメリット評価
  Step 4: 最適解選択 → 実装可能性・代替案確認
  Step 5: 実行計画策定 → 具体的手順・進捗監視方法

区切り文字システム適用:
  === HOTEL_CONTEXT === → プロジェクト背景明確化
  >>> TASK_OBJECTIVE >>> → 具体的目標設定
  ### STYLE_TONE ### → hotel-common特化スタイル
  ◆◆◆ CONSTRAINTS ◆◆◆ → 技術制約・要件明記
```

### **ステップ3: 事前ガードレール適用**
```yaml
実装前必須確認:
  ✅ TypeScript型安全性方針の確認
  ✅ セキュリティ要件の考慮
  ✅ 品質基準の遵守確認
  ✅ プロジェクト固有制約の確認

注意: 
  - 詳細なコード品質チェックはBackground Agent（常時監視）が自動実行
  - ここでは実装方向性の事前確認のみ
```

---

## **🏗️ 構造化プロンプト設計（文書準拠）**

### **必須要件（以下を必ず遵守すること）**
```yaml
データベース:
  ✅ PostgreSQL使用必須（hotel-common統一基盤）
  ✅ Prismaスキーマ厳密準拠
  ✅ マルチテナント: 全テーブルにtenant_id必須

認証・セキュリティ:
  ✅ JWT統一認証基盤使用必須
  ✅ プライバシー保護（GDPR準拠）必須
  ✅ データ暗号化必須

パフォーマンス:
  ✅ レスポンス時間: API 300ms以内必須
  ✅ チェックイン/アウト処理: 3秒以内必須
  ✅ 在庫検索: 1秒以内必須

TypeScript:
  ✅ strict mode有効必須
  ✅ コンパイルエラー: 0個必須
  ✅ 型安全性: 100%必須
```

### **推奨事項（可能な限り考慮すること）**
```yaml
実装品質:
  ✅ 単体テストカバレッジ80%以上
  ✅ 関数の複雑度10未満
  ✅ 関数の長さ50行以内
  ✅ コメント率15%以上

アーキテクチャ:
  ✅ Event-driven設計
  ✅ 非同期処理の活用
  ✅ キャッシュ戦略の実装
  ✅ リアルタイム同期対応
```

### **禁止事項（絶対に行わないこと）**
```yaml
❌ 型安全性の妥協（as any使用禁止）
❌ 仕様にない機能の勝手な追加
❌ セキュリティ要件の簡略化
❌ エラーハンドリングの省略
❌ テストケースの省略
❌ 平文でのパスワード保存
❌ 直接のSQLクエリ実行（ORM使用必須）
❌ tenantId漏れ（マルチテナント違反）
```

---

## **🎯 品質基準（文書準拠）**

### **必須基準（これらを満たさないコードは受け入れない）**
```yaml
コード品質:
  ✅ 単体テストカバレッジ80%以上
  ✅ 静的解析ツールでの警告0件
  ✅ ドキュメント内のすべてのAPIエンドポイント実装済み
  ✅ TypeScriptコンパイルエラー0個

セキュリティ:
  ✅ 認証・認可完全実装
  ✅ データ保護GDPR準拠
  ✅ 脆弱性0個

パフォーマンス:
  ✅ レスポンス時間最適化
  ✅ メモリ使用量効率化
  ✅ 負荷テスト通過
```

---

## **🚨 ハルシネーション防止システム**

### **実在性チェック（必須実行）**
```typescript
// 実装前必須チェックリスト
interface 実装前チェック {
  Prismaスキーマ確認: boolean;        // schema.prisma実在確認
  APIエンドポイント確認: boolean;     // 実際のAPI仕様確認
  型定義正確性: boolean;              // TypeScript型実在確認
  テーブル・フィールド確認: boolean;  // DB実在確認
}

// 確信度評価（必須）
interface 確信度評価 {
  スキーマ準拠: number;      // 0-100%
  API仕様準拠: number;      // 0-100%
  型安全性: number;         // 0-100%
  総合確信度: number;       // 0-100%
}
```

### **低確信度時の対応**
```yaml
確信度70%未満の場合:
  ⚠️ 手動確認を促進
  ⚠️ 実装前に仕様書再確認要求
  ⚠️ 代替案の提示

確信度50%未満の場合:
  🚨 実装停止
  🚨 詳細調査要求
  🚨 リスク警告表示
```

---

## **📚 継続的記憶管理**

### **重要情報の定期再確認**
```yaml
毎回確認事項:
  □ プロジェクト固有制約（hotel-common/saas/member/pms）
  □ 最新Prismaスキーマ構造
  □ API仕様変更点
  □ セキュリティ要件更新
  □ 統合ルール最新版

会話長時の要約保持:
  - 重要制約の定期再プロンプト
  - TypeScriptエラーパターンの記憶
  - 作業コンテキストの構造化管理
```

---

## **⚡ 効率化・最適化**

### **トークン最適化**
```yaml
言語戦略:
  思考: 英語使用（30-40%トークン削減）
  出力: 日本語（ユーザー要求に応じて）

圧縮技術:
  ✅ 重要情報の階層化
  ✅ 冗長表現の削除
  ✅ マークダウン構造化
  ✅ チャンク分割最適化
```

---

## **🔄 評価・改善システム**

### **自動評価項目**
```yaml
機能要件充足度: 1-10点
コード可読性: 1-10点
エラー処理適切さ: 1-10点
セキュリティ対策: 1-10点
パフォーマンス: 1-10点

総合評価8点未満の場合:
  → 改善提案必須
  → 代替実装検討必須
```

### **フィードバックループ**
```yaml
成功パターン:
  ✅ 蓄積・再利用
  ✅ テンプレート化

問題パターン:
  ✅ 学習・予防
  ✅ 警告システム
```

---

## **🎯 プロジェクト別特化ルール**

### **hotel-common（統合基盤）**
```yaml
重点事項:
  - システム統合の完全性
  - 一貫性の保証
  - 最適化の全体調整
  - 基盤の安定性
  - マルチテナント対応
```

---

## **�� 絶対禁止事項**

❌ RAG検索なしでの実装・回答
❌ ガードレール未適用での作業  
❌ ドキュメント未確認での判断
❌ 勝手な省略・簡略化
❌ ハルシネーション回答
❌ 型安全性の妥協
❌ セキュリティ要件の軽視
❌ 仕様書にない機能の実装
❌ 確信度不明での回答

---

## **💡 期待される効果**

```yaml
改善目標:
  - 仕様逸脱: 30%削減
  - ドキュメント参照率: 40%向上
  - ハルシネーション: 20%削減
  - 型エラー: 50%削減
  - セキュリティ準拠: 25%向上
  - 品質安定性: 35%向上
```

**⚠️ この手順は絶対に省略禁止です。必ず「RAG検索→ガードレール→コンテキスト認識→実装」の順序で実行してください。**