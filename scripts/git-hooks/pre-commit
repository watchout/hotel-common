#!/bin/bash
# データベースリセット関連の危険なコードが含まれていないかチェック

# 色の設定
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

echo -e "${GREEN}データベース安全性チェックを実行中...${NC}"

# 危険なパターンのリスト
DANGEROUS_PATTERNS=("migrate reset" "db push --force" "--force-reset" "rm ./prisma/dev.db" "drop database" "DROP DATABASE" "DELETE FROM" "delete from" "TRUNCATE" "truncate")
FILES_CHANGED=$(git diff --cached --name-only)

# 危険なパターンが含まれているかチェック
for file in $FILES_CHANGED; do
  if [[ $file == *.js || $file == *.ts || $file == *.cjs || $file == *.mjs || $file == *.sh || $file == *.sql ]]; then
    for pattern in "${DANGEROUS_PATTERNS[@]}"; do
      if grep -q "$pattern" "$file"; then
        echo -e "${RED}🚨 警告: $file に危険なデータベース操作が含まれています: $pattern${NC}"
        echo -e "${RED}❌ コミットを中止します。安全なデータベース操作に修正してください。${NC}"
        exit 1
      fi
    done
  fi
done

# データベース接続文字列の変更をチェック
if [[ $(git diff --cached --name-only | grep -E "schema.prisma|.env") ]]; then
  if git diff --cached | grep -E "^\+.*datasource|^\+.*DATABASE_URL"; then
    echo -e "${YELLOW}⚠️ データベース接続設定の変更が検出されました${NC}"
    echo -e "${YELLOW}⚠️ 変更が意図的であることを確認してください${NC}"
    echo -e "${YELLOW}⚠️ 続行するには 'y' を入力してください。中止するには他のキーを入力してください:${NC}"
    read -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
      echo -e "${RED}❌ コミットを中止します${NC}"
      exit 1
    fi
  fi
fi

echo -e "${GREEN}✅ データベース安全性チェックが完了しました${NC}"

# Prismaスキーマと型定義の整合性チェック
echo -e "${GREEN}Prismaスキーマチェックを実行中...${NC}"
bash scripts/git-hooks/prisma-check
if [ $? -ne 0 ]; then
  echo -e "${RED}❌ Prismaスキーマチェックエラー。コミットを中止します${NC}"
  exit 1
fi
echo -e "${GREEN}✅ Prismaスキーマチェック完了${NC}"

# Lint と 型チェックの実行
echo -e "${GREEN}ESLint/TypeScript チェックを実行中...${NC}"

# 変更されたファイルのみを対象にlint-staged風に実行（ESLintはプロジェクト根拠に走らせる）
CHANGED_TS=$(git diff --cached --name-only --diff-filter=ACM | grep -E "(.*)\.(ts|tsx)$" || true)
if [ -n "$CHANGED_TS" ]; then
  npx eslint $CHANGED_TS --max-warnings=0
  if [ $? -ne 0 ]; then
    echo -e "${RED}❌ ESLint エラー。コミットを中止します${NC}"
    exit 1
  fi
fi

# 型チェック（差分最適化が無い環境では全体チェック）
npx tsc --noEmit
if [ $? -ne 0 ]; then
  echo -e "${RED}❌ 型エラー。コミットを中止します${NC}"
  exit 1
fi

# 規約違反検知
echo -e "${GREEN}規約違反検知を実行中...${NC}"
node scripts/detect-coding-violations.js
if [ $? -ne 0 ]; then
  echo -e "${RED}❌ 規約違反が検出されました。コミットを中止します${NC}"
  exit 1
fi

echo -e "${GREEN}✅ Lint/型チェック完了${NC}"
exit 0