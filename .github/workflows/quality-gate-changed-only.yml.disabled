name: Quality Gate (Changed Files Only)

on:
  pull_request:
    branches: [main, develop]

jobs:
  lint-changed:
    name: ESLint (Changed Files - Strict)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å·®åˆ†å–å¾—ã«å¿…è¦

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Get changed TypeScript files
        id: changed-files
        uses: tj-actions/changed-files@v45
        with:
          files: |
            **/*.ts
            **/*.tsx
          files_ignore: |
            **/*.spec.ts
            **/*.test.ts
            dist/**
            node_modules/**

      - name: ESLint (Changed files only - Block on any warning)
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "ğŸ“‹ Changed files:"
          echo "${{ steps.changed-files.outputs.all_changed_files }}"
          echo ""
          npx eslint ${{ steps.changed-files.outputs.all_changed_files }} \
            --max-warnings=0 \
            --format stylish
        continue-on-error: false

      - name: Comment PR (if failed)
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âŒ **ESLint failed on changed files**\n\næ–°è¦å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã«è­¦å‘Š/ã‚¨ãƒ©ãƒ¼ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚\n\n**æ–¹é‡**: æ–°è¦ã‚³ãƒ¼ãƒ‰ã¯`--max-warnings=0`ï¼ˆè­¦å‘Š0ï¼‰å¿…é ˆã§ã™ã€‚\n\nä¿®æ­£æ–¹æ³•:\n1. `npx eslint <file> --fix` ã§è‡ªå‹•ä¿®æ­£\n2. æ‰‹å‹•ã§ä¿®æ­£\n3. ã‚„ã‚€ã‚’å¾—ãªã„å ´åˆã®ã¿Waiverï¼ˆç†ç”±ãƒ»æœŸé™ãƒ»æ‹…å½“å¿…é ˆï¼‰'
            })

  lint-full-report:
    name: ESLint (Full Repo - Report Only)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: ESLint (Full repo - Report only, does not block)
        continue-on-error: true
        run: |
          echo "ğŸ“Š å…¨ä½“ãƒ¬ãƒãƒ¼ãƒˆï¼ˆå‚è€ƒæƒ…å ±ã€ãƒ–ãƒ­ãƒƒã‚¯ã—ã¾ã›ã‚“ï¼‰"
          npx eslint . --ext .ts,.tsx --format stylish || true
          echo ""
          echo "âš ï¸ ä¸Šè¨˜ã¯æ—¢å­˜ã®è­¦å‘Šã‚’å«ã¿ã¾ã™ã€‚æ–°è¦PRã§ã¯å¢—ã‚„ã•ãªã„ã§ãã ã•ã„ã€‚"

      - name: Comment PR with report
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');
            const output = execSync('npx eslint . --ext .ts,.tsx --format compact 2>&1 | tail -3', { encoding: 'utf-8' });
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸ“Š **å…¨ä½“ã®è­¦å‘ŠçŠ¶æ³ï¼ˆå‚è€ƒï¼‰**\n\n```\n' + output + '\n```\n\nâœ… æ—¢å­˜ã®è­¦å‘Šã¯å‡çµæ¸ˆã¿ï¼ˆãƒ–ãƒ­ãƒƒã‚¯ã—ã¾ã›ã‚“ï¼‰\nâŒ æ–°è¦å¤‰æ›´ã§è­¦å‘Šã‚’å¢—ã‚„ã™ã¨ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã™'
            })

