name: Quality Gate (ESLint)

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - '**/*.ts'
      - '**/*.tsx'
      - 'eslint.config.mjs'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'yarn.lock'
      - 'package-lock.json'

jobs:
  lint:
    name: ESLint (changed files block / whole repo report)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Get changed files
        id: cf
        uses: tj-actions/changed-files@v45
        with:
          files: |
            **/*.ts
            **/*.tsx
      - name: ESLint (changed only, block)
        if: steps.cf.outputs.any_changed == 'true'
        run: npx eslint ${{ steps.cf.outputs.all_changed_files }} --max-warnings=0
      - name: ESLint (whole repo, report only)
        continue-on-error: true
        run: npx eslint . || true
      - name: Summarize
        if: always()
        run: |
          echo "### âœ… ESLint job finished" >> $GITHUB_STEP_SUMMARY
          echo "- Changed files: ${{ steps.cf.outputs.all_changed_files }}" >> $GITHUB_STEP_SUMMARY

  waiver-ttl:
    name: Expired Waiver Guard
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Fail expired waivers
        run: |
          TODAY=$(date +%Y-%m-%d)
          set -o pipefail
          MATCHES=$(grep -RIn --include=*.{ts,tsx} "WAIVER:.*until:" . || true)
          if [ -z "$MATCHES" ]; then
            echo "No waivers found."
            exit 0
          fi
          echo "$MATCHES" | awk -v today="$TODAY" '
            {
              match($0,/until:([0-9-]+)/,a);
              if (a[1] != "" && a[1] < today) {
                print "Expired:", $0; fail=1
              }
            }
            END { exit fail }
          '
