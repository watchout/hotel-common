name: SSOT Compliance Check

on:
  pull_request:
    branches:
      - main
      - develop

jobs:
  ssot-reference-check:
    name: SSOT参照チェック
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check SSOT references in PR body
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          echo "📋 PR本文をチェック中..."
          echo "$PR_BODY"
          
          # SSOT参照の確認（簡易版）
          if echo "$PR_BODY" | grep -i "docs/03_ssot/" > /dev/null; then
            echo "✅ SSOT参照が見つかりました"
          elif echo "$PR_BODY" | grep -i "ssot" > /dev/null; then
            echo "⚠️  'SSOT'の記載はありますが、具体的なファイルパスがありません"
            echo "💡 推奨: docs/03_ssot/xxx/SSOT_XXX.md @ vX.X.X の形式で記載"
            exit 0
          else
            echo "⚠️  SSOT参照が見つかりません"
            echo "💡 機能追加・変更の場合は、該当SSOTを参照してください"
            echo "   例: docs/03_ssot/00_foundation/SSOT_DATABASE_SCHEMA.md @ latest"
            exit 0
          fi
      
      - name: Check for requirement IDs in code (optional)
        run: |
          echo "📋 コード内の要件ID参照をチェック中..."
          
          # 要件IDコメントの検出（XXX-nnn形式）
          REQ_IDS=$(grep -r "// REQ-" --include="*.ts" src/ 2>/dev/null || echo "")
          
          if [ -n "$REQ_IDS" ]; then
            echo "✅ 要件ID参照が見つかりました："
            echo "$REQ_IDS" | head -5
          else
            echo "ℹ️  要件ID参照は見つかりませんでした（任意）"
          fi
