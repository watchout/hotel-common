name: API Monitoring & Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # æ¯æ—¥åˆå‰9æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  api-monitoring:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: hotel_common_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Setup test environment
      run: |
        cp env.example .env
        echo "DATABASE_URL=postgresql://postgres:postgres@localhost:5432/hotel_common_test" >> .env
        echo "JWT_SECRET=test-secret-key" >> .env
        echo "NODE_ENV=test" >> .env
    
    - name: Run database migrations
      run: |
        npx prisma generate
        npx prisma db push --force-reset
    
    - name: Build application
      run: npm run build
    
    - name: Start server in background
      run: |
        npm start &
        sleep 10
        # ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã™ã‚‹ã¾ã§å¾…æ©Ÿ
        for i in {1..30}; do
          if curl -f http://localhost:3400/health; then
            echo "Server is ready"
            break
          fi
          echo "Waiting for server... ($i/30)"
          sleep 2
        done
    
    - name: Run API monitoring
      run: npm run api-monitor
      continue-on-error: true
    
    - name: Run API specification validation
      run: npm run api-spec-validate
      continue-on-error: true
    
    - name: Upload monitoring reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: api-monitoring-reports
        path: |
          reports/api-monitoring/
          reports/api-validation/
        retention-days: 30
    
    - name: Comment PR with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          try {
            // æœ€æ–°ã®ç›£è¦–ãƒ¬ãƒãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿
            const monitoringReport = JSON.parse(
              fs.readFileSync('reports/api-monitoring/latest.json', 'utf8')
            );
            
            const validationReport = JSON.parse(
              fs.readFileSync('reports/api-validation/latest.json', 'utf8')
            );
            
            const comment = `## ğŸ” APIç›£è¦–ãƒ»æ¤œè¨¼çµæœ
            
            ### ğŸ“Š APIå®Ÿè£…çŠ¶æ³
            - **ç·ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆæ•°**: ${monitoringReport.summary.total}
            - **å®Ÿè£…æ¸ˆã¿**: ${monitoringReport.summary.implemented}
            - **æœªå®Ÿè£…**: ${monitoringReport.summary.notImplemented}
            - **å®Ÿè£…ç‡**: ${monitoringReport.summary.implementationRate}
            
            ### ğŸ“š ä»•æ§˜æ›¸åŒæœŸçŠ¶æ³
            - **ä»•æ§˜æ›¸ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: ${validationReport.summary.docsEndpoints}
            - **å®Ÿè£…ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: ${validationReport.summary.implEndpoints}
            - **ä»•æ§˜æ›¸-å®Ÿè£…ä¸€è‡´ç‡**: ${validationReport.summary.docsImplMatchRate}
            
            ### ğŸš¨ æ³¨æ„ãŒå¿…è¦ãªé …ç›®
            ${validationReport.analysis.missingInImplementation.length > 0 ? 
              `- **ä»•æ§˜æ›¸ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ãŒæœªå®Ÿè£…**: ${validationReport.analysis.missingInImplementation.length}å€‹` : ''}
            ${validationReport.analysis.missingInDocs.length > 0 ? 
              `- **å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ãŒä»•æ§˜æ›¸ã«ãªã„**: ${validationReport.analysis.missingInDocs.length}å€‹` : ''}
            
            è©³ç´°ãªãƒ¬ãƒãƒ¼ãƒˆã¯Artifactsã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          } catch (error) {
            console.log('ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹ã€èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error.message);
          }

  api-health-check:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run API health check
      run: npm run api-health
      continue-on-error: true
    
    - name: Send Slack notification on failure
      if: failure()
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        text: 'APIç›£è¦–ã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
